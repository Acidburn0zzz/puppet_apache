# <%= servername %>
<%- if run_mode.to_s =~ /(proxy\-|static\-)itk/ -%>
<IfDefine HttpdLocal>
<%- end -%>
<%- unless ssl_mode.to_s == 'only'  then -%>
<VirtualHost *:80>
    Include include.d/defaults.inc

    ServerName <%= servername %>
    <%- unless serveralias.to_s.empty? then -%>
    ServerAlias <%= serveralias %>
    <%- end -%> 
    <%- unless server_admin.to_s.empty? or server_admin.to_s == 'absent' then -%>
    ServerAdmin <%= server_admin %>
    <%- end -%>
    DocumentRoot <%= documentroot %>/

    <%- case logmode.to_s
        when 'nologs' -%>
    ErrorLog /dev/null
    CustomLog /dev/null
    <%- when 'semianonym' -%>
    ErrorLog <%= logdir %>/error_log
    CustomLog <%= logdir %>/access_log noip
    <%- when 'anonym' -%>
    ErrorLog /dev/null
    CustomLog <%= logdir %>/access_log noip
    <%- else -%>
    ErrorLog <%= logdir %>/error_log
    CustomLog <%= logdir %>/access_log combined
    <%- end -%>

    <%- if ssl_mode.to_s == 'force' then -%>
    Redirect permanent / https://<%= servername %>/

    <%- end -%>
    <%- if default_charset.to_s != 'absent' then -%>
    AddDefaultCharset <%= default_charset %>

    <%- end -%>
    <%- if run_mode.to_s =~ /(proxy\-|static\-)?itk/ -%>
    <IfModule mpm_itk_module>
        AssignUserId <%= run_uid+" "+run_gid %>
    </IfModule>

    <%- end -%>
    <%- if not ssl_mode.to_s == 'force' then -%>
    <Directory "<%= documentroot %>/">
        AllowOverride <%= allow_override %>
        <%- if options.to_s != 'absent' or do_includes.to_s == 'true' then -%>
        Options <%- unless options.to_s == 'absent' then -%><%= options %><%- end -%><%- if do_includes.to_s == 'true' and not options.include?('+Includes') then -%> +Includes<%- end -%>

        <%- end -%>
        <%- unless htpasswd_file.to_s == 'absent' then -%>
        AuthType Basic
        AuthName "Access fuer <%= servername %>"
        AuthUserFile <%= real_htpasswd_path %>
        require valid-user
        <%- end -%>
    </Directory>

    <%- unless htpasswd_file.to_s == 'absent' then -%>
    <Directory "<%= cgi_binpath %>/">
        AuthType Basic
        AuthName "Access fuer <%= servername %>"
        AuthUserFile <%= real_htpasswd_path %>
        require valid-user
    </Directory>
    <%- end -%>
    ScriptAlias /cgi-bin/ <%= cgi_binpath %>/
    <%- end -%>

    <%- unless run_mode.to_s =~ /(proxy\-|static\-)itk/ -%>
    <IfModule mod_security2.c>
        <%- if mod_security.to_s == 'true' then -%>
        SecRuleEngine On
        <%- if mod_security_relevantonly.to_s == 'true' then -%>
        SecAuditEngine RelevantOnly
        <%- else -%>
        SecAuditEngine On
        <%- end -%>
        <%- else -%>
        SecRuleEngine Off
        SecAuditEngine Off
        <%- end -%>
        SecAuditLogType Concurrent
        SecAuditLogStorageDir <%= logdir %>/
        SecAuditLog <%= logdir %>/mod_security_audit.log
        SecDebugLog <%= logdir %>/mod_security_debug.log
    </IfModule>
    <%- end -%>

    <%- unless additional_options.to_s == 'absent' then -%>
    <%= additional_options %>
    <%- end -%>
</VirtualHost>
<%- end -%>

<%- unless ssl_mode.to_s == 'false'  then -%>
<VirtualHost *:443>
    Include include.d/defaults.inc
    Include include.d/ssl_defaults.inc

    ServerName <%= servername %>
    <%- unless serveralias.to_s.empty? then -%>
    ServerAlias <%= serveralias %>
    <%- end -%> 
    <%- unless server_admin.to_s.empty? or server_admin.to_s == 'absent' then -%>
    ServerAdmin <%= server_admin %>
    <%- end -%>
    DocumentRoot <%= documentroot %>/

    <%- case logmode.to_s
        when 'nologs' -%>
    ErrorLog /dev/null
    CustomLog /dev/null
    <%- when 'semianonym' -%>
    ErrorLog <%= logdir %>/error_log
    CustomLog <%= logdir %>/access_log noip
    <%- when 'anonym' -%>
    ErrorLog /dev/null
    CustomLog <%= logdir %>/access_log noip
    <%- else -%>
    ErrorLog <%= logdir %>/error_log
    CustomLog <%= logdir %>/access_log combined
    <%- end -%>

    <%- if default_charset.to_s != 'absent' then -%>
    AddDefaultCharset <%= default_charset %>

    <%- end -%>
    <%- if run_mode.to_s =~ /(proxy\-|static\-)?itk/ -%>
    <IfModule mpm_itk_module>
        AssignUserId <%= run_uid+" "+run_gid %>
    </IfModule>

    <%- end -%>
    <Directory "<%= documentroot %>/">
        AllowOverride <%= allow_override %>
        <%- if options.to_s != 'absent' or do_includes.to_s == 'true' then -%>
        Options <%- unless options.to_s == 'absent' then -%><%= options %><%- end -%><%- if do_includes.to_s == 'true' and not options.include?('+Includes') then -%> +Includes<%- end -%>

        <%- end -%>
        <%- unless htpasswd_file.to_s == 'absent' then -%>
        AuthType Basic
        AuthName "Access fuer <%= servername %>"
        AuthUserFile <%= real_htpasswd_path %>
        require valid-user
        <%- end -%>
    </Directory>

    ScriptAlias /cgi-bin/ <%= cgi_binpath %>/
    <%- unless htpasswd_file.to_s == 'absent' then -%>
    <Directory "<%= cgi_binpath %>/">
        AuthType Basic
        AuthName "Access fuer <%= servername %>"
        AuthUserFile <%= real_htpasswd_path %>
        require valid-user
    </Directory>
    <%- end -%>

    <%- unless run_mode.to_s =~ /(proxy\-|static\-)itk/ -%>
    <IfModule mod_security2.c>
        <%- if mod_security.to_s == 'true' then -%>
        SecRuleEngine On
        <%- if mod_security_relevantonly.to_s == 'true' then -%>
        SecAuditEngine RelevantOnly
        <%- else -%>
        SecAuditEngine On
        <%- end -%>
        <%- else -%>
        SecRuleEngine Off
        SecAuditEngine Off
        <%- end -%>
        SecAuditLogType Concurrent
        SecAuditLogStorageDir <%= logdir %>/
        SecAuditLog <%= logdir %>/mod_security_audit.log
        SecDebugLog <%= logdir %>/mod_security_debug.log
    </IfModule>
    <%- end -%>

    <%- unless additional_options.to_s == 'absent' then -%>
    <%= additional_options %>
    <%- end -%>
</VirtualHost>
<%- end -%>
<%- if run_mode.to_s =~ /(proxy\-|static\-)itk/ -%>
</IfDefine>
<IfDefine !HttpdLocal>
<%- unless ssl_mode.to_s == 'only'  then -%>
<VirtualHost *:80>

    Include include.d/defaults.inc

    ServerName <%= servername %>
    <%- unless serveralias.to_s.empty? then -%>
    ServerAlias <%= serveralias %>
    <%- end -%>
    <%- unless server_admin.to_s.empty? or server_admin.to_s == 'absent' then -%>
    ServerAdmin <%= server_admin %>
    <%- end -%>
    <%- if run_mode.to_s == 'static-itk' -%>
    DocumentRoot <%= documentroot %>/
    DirectoryIndex index.htm index.html index.pl
    <%- end -%>

    <%- case logmode.to_s
        when 'nologs' -%>
    ErrorLog /dev/null
    CustomLog /dev/null
    <%- when 'semianonym' -%>
    ErrorLog <%= logdir %>/<%= logfileprefix %>-error_log
    CustomLog <%= logdir %>/<%= logfileprefix %>-access_log noip
    <%- when 'anonym' -%>
    ErrorLog /dev/null
    CustomLog <%= logdir %>/<%= logfileprefix %>-access_log noip
    <%- else -%>
    ErrorLog <%= logdir %>/<%= logfileprefix %>-error_log
    CustomLog <%= logdir %>/<%= logfileprefix %>-access_log combined
    <%- end -%>

    ProxyPreserveHost On
    ProxyRequests off
    <%- if run_mode.to_s == 'static-itk' -%>
    ProxyPassMatch ^/(.*\.pl/?.*)$ http://127.0.0.1/$1
    <%- else -%>
    ProxyPass / http://127.0.0.1/
    <%- end -%>
    ProxyPassReverse / http://127.0.0.1/

    <%- if ssl_mode.to_s == 'force' then -%>
    Redirect permanent / https://<%= servername %>/

    <%- end -%>
    <%- if default_charset.to_s != 'absent' then -%>
    AddDefaultCharset <%= default_charset %>

    <%- end -%>
    <%- if run_mode.to_s == 'static-itk' then -%>
    <%- if not ssl_mode.to_s == 'force' then -%>
    <Directory "<%= documentroot %>/">
        AllowOverride <%= allow_override %>
        <%- if options.to_s != 'absent' or do_includes.to_s == 'true' then -%>
        Options <%- unless options.to_s == 'absent' then -%><%= options %><%- end -%><%- if do_includes.to_s == 'true' and not options.include?('+Includes') then -%> +Includes<%- end -%>

        <%- end -%>
        <%- unless htpasswd_file.to_s == 'absent' then -%>
        AuthType Basic
        AuthName "Access fuer <%= servername %>"
        AuthUserFile <%= real_htpasswd_path %>
        require valid-user
        <%- end -%>
    </Directory>

    <%- unless htpasswd_file.to_s == 'absent' then -%>
    <Directory "<%= cgi_binpath %>/">
        AuthType Basic
        AuthName "Access fuer <%= servername %>"
        AuthUserFile <%= real_htpasswd_path %>
        require valid-user
    </Directory>
    <%- end -%>
    ScriptAlias /cgi-bin/ <%= cgi_binpath %>/
    <%- end -%>
    <%- end -%>

    <IfModule mod_security2.c>
        <%- if mod_security.to_s == 'true' then -%>
        SecRuleEngine On
        <%- if mod_security_relevantonly.to_s == 'true' then -%>
        SecAuditEngine RelevantOnly
        <%- else -%>
        SecAuditEngine On
        <%- end -%>
        <%- else -%>
        SecRuleEngine Off
        SecAuditEngine Off
        <%- end -%>
        SecAuditLogType Concurrent
        SecAuditLogStorageDir <%= logdir %>/
        SecAuditLog <%= logdir %>/mod_security_audit.log
        SecDebugLog <%= logdir %>/mod_security_debug.log
    </IfModule>

    <%- unless additional_options.to_s == 'absent' then -%>
    <%= additional_options %>
    <%- end -%>
</VirtualHost>
<%- end -%>

<%- unless ssl_mode.to_s == 'false'  then -%>
<VirtualHost *:443>
    Include include.d/defaults.inc
    Include include.d/ssl_defaults.inc

    ServerName <%= servername %>
    <%- unless serveralias.to_s.empty? then -%>
    ServerAlias <%= serveralias %>
    <%- end -%>
    <%- unless server_admin.to_s.empty? or server_admin.to_s == 'absent' then -%>
    ServerAdmin <%= server_admin %>
    <%- end -%>
    <%- if run_mode.to_s == 'static-itk' -%>
    DocumentRoot <%= documentroot %>/
    DirectoryIndex index.htm index.html index.pl
    <%- end -%>

    ProxyPreserveHost On
    ProxyRequests off
    <%- if run_mode.to_s == 'static-itk' -%>
    ProxyPassMatch ^/(.*\.pl/?.*)$ https://127.0.0.1/$1
    <%- else -%>
    ProxyPass / https://127.0.0.1/
    <%- end -%>
    ProxyPassReverse / https://127.0.0.1/

    <%- case logmode.to_s
        when 'nologs' -%>
    ErrorLog /dev/null
    CustomLog /dev/null
    <%- when 'semianonym' -%>
    ErrorLog <%= logdir %>/<%= logfileprefix %>-error_log
    CustomLog <%= logdir %>/<%= logfileprefix %>-access_log noip
    <%- when 'anonym' -%>
    ErrorLog /dev/null
    CustomLog <%= logdir %>/<%= logfileprefix %>-access_log noip
    <%- else -%>
    ErrorLog <%= logdir %>/<%= logfileprefix %>-error_log
    CustomLog <%= logdir %>/<%= logfileprefix %>-access_log combined
    <%- end -%>

    <%- if default_charset.to_s != 'absent' then -%>
    AddDefaultCharset <%= default_charset %>

    <%- end -%>
    <%- unless run_mode.to_s == 'static-itk' -%>
    <Directory "<%= documentroot %>/">
        AllowOverride <%= allow_override %>
        <%- if options.to_s != 'absent' or do_includes.to_s == 'true' then -%>
        Options <%- unless options.to_s == 'absent' then -%><%= options %><%- end -%><%- if do_includes.to_s == 'true' and not options.include?('+Includes') then -%> +Includes<%- end -%>

        <%- end -%>
        <%- unless htpasswd_file.to_s == 'absent' then -%>
        AuthType Basic
        AuthName "Access fuer <%= servername %>"
        AuthUserFile <%= real_htpasswd_path %>
        require valid-user
        <%- end -%>
    </Directory>

    <%- if htpasswd_file.to_s == 'absent' then -%>
    <Directory "<%= cgi_binpath %>/">
        AuthType Basic
        AuthName "Access fuer <%= servername %>"
        AuthUserFile <%= real_htpasswd_path %>
        require valid-user
    </Directory>
    <%- end -%>
    ScriptAlias /cgi-bin/ <%= cgi_binpath %>/
    <%- end -%>

    <IfModule mod_security2.c>
        <%- if mod_security.to_s == 'true' then -%>
        SecRuleEngine On
        <%- if mod_security_relevantonly.to_s == 'true' then -%>
        SecAuditEngine RelevantOnly
        <%- else -%>
        SecAuditEngine On
        <%- end -%>
        <%- else -%>
        SecRuleEngine Off
        SecAuditEngine Off
        <%- end -%>
        SecAuditLogType Concurrent
        SecAuditLogStorageDir <%= logdir %>/
        SecAuditLog <%= logdir %>/mod_security_audit.log
        SecDebugLog <%= logdir %>/mod_security_debug.log
    </IfModule>

    <%- unless additional_options.to_s == 'absent' then -%>
    <%= additional_options %>
    <%- end -%>
</VirtualHost>
<%- end -%>
</IfDefine>
<%- end -%>
