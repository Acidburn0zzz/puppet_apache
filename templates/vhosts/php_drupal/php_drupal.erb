# <%= servername %>
<%- if run_mode.to_s =~ /(proxy\-|static\-)itk/ -%>
<IfDefine HttpdLocal>
<%- end -%>
<%- unless ssl_mode.to_s == 'only'  then -%>
<VirtualHost *:80>
<%  scope.unsetvar('vhost_part')
  scope.setvar('vhost_part',:normal) -%> 
  <%= scope.function_template('apache/vhosts/partials/header_default.erb') %>
<%  scope.unsetvar('vhost_part') -%>

<%= scope.function_template('apache/vhosts/partials/logs.erb') %>
    <%- if ssl_mode.to_s == 'force' then -%>
    RewriteEngine On
    RewriteCond %{HTTPS} !=on
    RewriteRule (.*) https://%{SERVER_NAME}$1 [R=permanent,L]

    <%- end -%>
    <%- if run_mode.to_s =~ /(proxy\-|static\-)?itk/ -%>
    <IfModule mpm_itk_module>
        AssignUserId <%= run_uid+" "+run_gid %>
    </IfModule>

    <%- end -%>
    <%- if not ssl_mode.to_s == 'force' then -%>
    <Directory "<%= documentroot %>/">
        AllowOverride <%= allow_override %>
        <%- if options.to_s != 'absent' or do_includes.to_s == 'true' then -%>
        Options <%- unless options.to_s == 'absent' then -%><%= options %><%- end -%><%- if do_includes.to_s == 'true' and not options.include?('+Includes') then -%> +Includes<%- end -%>

        <%- end -%>
<%= scope.function_template('apache/vhosts/partials/authentication.erb') %>
        php_admin_flag engine on
        <%- unless php_default_charset.to_s == 'absent' then -%>
        php_admin_value default_charset <%= php_default_charset %>
        <%- end -%>
        php_admin_value open_basedir <%= documentroot %>:<%= real_php_upload_tmp_dir %>:<%= real_php_session_save_path %>
        php_admin_value upload_tmp_dir <%= real_php_upload_tmp_dir %>
        php_admin_value session.save_path <%= real_php_session_save_path %>
        <%- unless php_safe_mode_exec_bins.to_s == 'absent' then -%>
        php_admin_value safe_mode_exec_dir <%= real_php_safe_mode_exec_bin_dir %>
        <%- end -%>

        php_value magic_quotes_gpc                0
        php_value register_globals                0
        php_value session.auto_start              0
        php_value mbstring.http_input             pass
        php_value mbstring.http_output            pass
        php_value mbstring.encoding_translation   0

        # Protect files and directories from prying eyes.
        <FilesMatch "\.(engine|inc|info|install|module|profile|po|sh|.*sql|theme|tpl(\.php)?|xtmpl)$|^(code-style\.pl|Entries.*|Repository|Root|Tag|Template)$">
            Order allow,deny
        </FilesMatch>

        # Customized error messages.
        ErrorDocument 404 /index.php

        RewriteEngine on
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^(.*)$ index.php?q=$1 [L,QSA]
    </Directory>
    <Directory "<%= documentroot %>/files/">
        SetHandler Drupal_Security_Do_Not_Remove_See_SA_2006_006
        Options None
        Options +FollowSymLinks
    </Directory>
    <%- end -%>
	
    <%- unless run_mode.to_s =~ /(proxy\-|static\-)itk/ -%>
<%= scope.function_template('apache/vhosts/partials/mod_security.erb') %>
    <%- end -%>

    <%- unless additional_options.to_s == 'absent' then -%>
    <%= additional_options %>
    <%- end -%>
</VirtualHost>
<%- end -%>

<%- unless ssl_mode.to_s == 'false'  then -%>
<VirtualHost *:443>
<%  scope.unsetvar('vhost_part')
  scope.setvar('vhost_part',:ssl) -%> 
  <%= scope.function_template('apache/vhosts/partials/header_default.erb') %>
<%  scope.unsetvar('vhost_part') -%>

<%= scope.function_template('apache/vhosts/partials/logs.erb') %>

    <%- if run_mode.to_s =~ /(proxy\-|static\-)?itk/ -%>

    <IfModule mpm_itk_module>
        AssignUserId <%= run_uid+" "+run_gid %>
    </IfModule>
    <%- end -%>

    <Directory "<%= documentroot %>/">
        AllowOverride <%= allow_override %>
        <%- if options.to_s != 'absent' or do_includes.to_s == 'true' then -%>
        Options <%- unless options.to_s == 'absent' then -%><%= options %><%- end -%><%- if do_includes.to_s == 'true' and not options.include?('+Includes') then -%> +Includes<%- end -%>

        <%- end -%>
<%= scope.function_template('apache/vhosts/partials/authentication.erb') %>
        php_admin_flag engine on
        <%- unless php_default_charset.to_s == 'absent' then -%>
        php_admin_value default_charset <%= php_default_charset %>
        <%- end -%>
        php_admin_value open_basedir <%= documentroot %>:<%= real_php_upload_tmp_dir %>:<%= real_php_session_save_path %>
        php_admin_value upload_tmp_dir <%= real_php_upload_tmp_dir %>
        php_admin_value session.save_path <%= real_php_session_save_path %>
        <%- unless php_safe_mode_exec_bins.to_s == 'absent' then -%>
        php_admin_value safe_mode_exec_dir <%= real_php_safe_mode_exec_bin_dir %>
        <%- end -%>

        php_value magic_quotes_gpc                0       
        php_value register_globals                0       
        php_value session.auto_start              0       
        php_value mbstring.http_input             pass    
        php_value mbstring.http_output            pass    
        php_value mbstring.encoding_translation   0

        # Protect files and directories from prying eyes.
        <FilesMatch "\.(engine|inc|info|install|module|profile|po|sh|.*sql|theme|tpl(\.php)?|xtmpl)$|^(code-style\.pl|Entries.*|Repository|Root|Tag|Template)$">
            Order allow,deny                  
        </FilesMatch>                                         

        # Customized error messages.
        ErrorDocument 404 /index.php

        RewriteEngine on
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^(.*)$ index.php?q=$1 [L,QSA] 
    </Directory>
    <Directory "<%= documentroot %>/files/">
        SetHandler Drupal_Security_Do_Not_Remove_See_SA_2006_006
        Options None
        Options +FollowSymLinks
    </Directory>

    <%- unless run_mode.to_s =~ /(proxy\-|static\-)itk/ -%>
<%= scope.function_template('apache/vhosts/partials/mod_security.erb') %>
    <%- end -%>

    <%- unless additional_options.to_s == 'absent' then -%>
    <%= additional_options %>
    <%- end -%>
</VirtualHost>
<%- end -%>
<%- if run_mode.to_s =~ /(proxy\-|static\-)itk/ -%>
</IfDefine>
<IfDefine !HttpdLocal>
<%- unless ssl_mode.to_s == 'only'  then -%>
<VirtualHost *:80>
<%  scope.unsetvar('vhost_part')
  scope.setvar('vhost_part',:normal) -%> 
  <%= scope.function_template('apache/vhosts/partials/header_default.erb') %>
<%  scope.unsetvar('vhost_part') -%>
    DirectoryIndex index.htm index.html index.php

<%= scope.function_template('apache/vhosts/partials/logs.erb') %>

    ProxyPreserveHost On
    ProxyRequests off
    <%- if run_mode.to_s == 'static-itk' -%>
    ProxyPassMatch ^/(.*\.php/?.*)$ http://127.0.0.1/$1
    <%- else -%>
    ProxyPass / http://127.0.0.1/
    <%- end -%>
    ProxyPassReverse / http://127.0.0.1/

    <%- if ssl_mode.to_s == 'force' then -%>
    RewriteEngine On
    RewriteCond %{HTTPS} !=on
    RewriteRule (.*) https://%{SERVER_NAME}$1 [R=permanent,L]

    <%- end -%>

    <%- if run_mode.to_s == 'static-itk' then -%>
    <%- if not ssl_mode.to_s == 'force' then -%>
    <Directory "<%= documentroot %>/">
        AllowOverride <%= allow_override %>
        <%- if options.to_s != 'absent' or do_includes.to_s == 'true' then -%>
        Options <%- unless options.to_s == 'absent' then -%><%= options %><%- end -%><%- if do_includes.to_s == 'true' and not options.include?('+Includes') then -%> +Includes<%- end -%>

        <%- end -%>
<%= scope.function_template('apache/vhosts/partials/authentication.erb') %>

        # Protect files and directories from prying eyes.
        <FilesMatch "\.(engine|inc|info|install|module|profile|po|sh|.*sql|theme|tpl(\.php)?|xtmpl)$|^(code-style\.pl|Entries.*|Repository|Root|Tag|Template)$">
            Order allow,deny
        </FilesMatch>

        # Customized error messages.
        ErrorDocument 404 /index.php

        RewriteEngine on
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^(.*)$ index.php?q=$1 [L,QSA]
    </Directory>
    <Directory "<%= documentroot %>/files/">
        SetHandler Drupal_Security_Do_Not_Remove_See_SA_2006_006
        Options None
        Options +FollowSymLinks
    </Directory>
    <%- end -%>
    <%- end -%>

<%= scope.function_template('apache/vhosts/partials/mod_security.erb') %>

    <%- unless additional_options.to_s == 'absent' then -%>
    <%= additional_options %>
    <%- end -%>
</VirtualHost>
<%- end -%>

<%- unless ssl_mode.to_s == 'false'  then -%>
<VirtualHost *:443>
<%  scope.unsetvar('vhost_part')
  scope.setvar('vhost_part',:ssl) -%> 
  <%= scope.function_template('apache/vhosts/partials/header_default.erb') %>
<%  scope.unsetvar('vhost_part') -%>
    DirectoryIndex index.htm index.html index.php

<%= scope.function_template('apache/vhosts/partials/logs.erb') %>

    ProxyPreserveHost On
    ProxyRequests off
    SSLProxyEngine On
    <%- if run_mode.to_s == 'static-itk' -%>
    ProxyPassMatch ^/(.*\.php/?.*)$ https://127.0.0.1/$1
    <%- else -%>
    ProxyPass / https://127.0.0.1/
    <%- end -%>
    ProxyPassReverse / https://127.0.0.1/

    <%- if run_mode.to_s == 'static-itk' -%>
    <Directory "<%= documentroot %>/">
        AllowOverride <%= allow_override %>
        <%- if options.to_s != 'absent' or do_includes.to_s == 'true' then -%>
        Options <%- unless options.to_s == 'absent' then -%><%= options %><%- end -%><%- if do_includes.to_s == 'true' and not options.include?('+Includes') then -%> +Includes<%- end -%>

        <%- end -%>
<%= scope.function_template('apache/vhosts/partials/authentication.erb') %>

        # Protect files and directories from prying eyes.
        <FilesMatch "\.(engine|inc|info|install|module|profile|po|sh|.*sql|theme|tpl(\.php)?|xtmpl)$|^(code-style\.pl|Entries.*|Repository|Root|Tag|Template)$">
            Order allow,deny
        </FilesMatch>

        # Customized error messages.
        ErrorDocument 404 /index.php

        RewriteEngine on
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^(.*)$ index.php?q=$1 [L,QSA]
    </Directory>
    <Directory "<%= documentroot %>/files/">
        SetHandler Drupal_Security_Do_Not_Remove_See_SA_2006_006
        Options None
        Options +FollowSymLinks
    </Directory>
    <%- end -%>

<%= scope.function_template('apache/vhosts/partials/mod_security.erb') %>

    <%- unless additional_options.to_s == 'absent' then -%>
    <%= additional_options %>
    <%- end -%>
</VirtualHost>
<%- end -%>
</IfDefine>
<%- end -%>
