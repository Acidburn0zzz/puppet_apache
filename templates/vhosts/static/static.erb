# <%= servername %>
<%- unless ssl_mode.to_s == 'only'  then -%>
<VirtualHost *:80>
<%= scope.function_template('apache/vhosts/partials/header_default.erb') %>

<%= scope.function_template('apache/vhosts/partials/logs.erb') %>
    <%- if ssl_mode.to_s == 'force' then -%>
    RewriteEngine On
    RewriteCond %{HTTPS} !=on
    RewriteRule (.*) https://%{SERVER_NAME}$1 [R=permanent,L]

    <%- end -%>

    <%- if not ssl_mode.to_s == 'force' then -%>
    <Directory "<%= documentroot %>/">
        AllowOverride <%= allow_override %>
        <%- if options.to_s != 'absent' or do_includes.to_s == 'true' then -%>
        Options <%- unless options.to_s == 'absent' then -%><%= options %><%- end -%><%- if do_includes.to_s == 'true' and not options.include?('+Includes') then -%> +Includes<%- end -%>

        <%- end -%>
<%= scope.function_template('apache/vhosts/partials/authentication.erb') %>
    </Directory>
    <%- end -%>

<%= scope.function_template('apache/vhosts/partials/mod_security.erb') %>

    <%- unless additional_options.to_s == 'absent' then -%>
    <%= additional_options %>
    <%- end -%>
</VirtualHost>
<%- end -%>

<%- unless ssl_mode.to_s == 'false'  then -%>
<VirtualHost *:443>
<%  scope.unsetvar('vhost_part')
  scope.setvar('vhost_part',:ssl) -%> 
  <%= scope.function_template('apache/vhosts/partials/header_default.erb') %>
<%  scope.unsetvar('vhost_part') -%>

<%= scope.function_template('apache/vhosts/partials/logs.erb') %>

    <Directory "<%= documentroot %>/">
        AllowOverride <%= allow_override %>
        <%- if options.to_s != 'absent' or do_includes.to_s == 'true' then -%>
        Options <%= options %><%- if do_includes.to_s == 'true' and not options.include?('+Includes') then -%> +Includes<%- end -%>

        <%- end -%>
<%= scope.function_template('apache/vhosts/partials/authentication.erb') %>
    </Directory>

<%= scope.function_template('apache/vhosts/partials/mod_security.erb') %>

    <%- unless additional_options.to_s == 'absent' then -%>
    <%= additional_options %>
    <%- end -%>
</VirtualHost>
<%- end -%>
