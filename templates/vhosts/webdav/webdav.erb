# <%= servername %>
<%- if run_mode.to_s =~ /(proxy\-|static\-)itk/ -%>
<IfDefine HttpdLocal>
<%- end -%>
<%- unless ssl_mode.to_s == 'only'  then -%>
<VirtualHost *:80>
    Include include.d/defaults.inc

    ServerName <%= servername %>
    <%- unless serveralias.to_s.empty? then -%>
    ServerAlias <%= serveralias %>
    <%- end -%> 
    <%- unless server_admin.to_s.empty? or server_admin.to_s == 'absent' then -%>
    ServerAdmin <%= server_admin %>
    <%- end -%>
    DocumentRoot <%= documentroot %>/

<%= scope.function_template('apache/vhosts/partials/logs.erb') %>

    <%- if ssl_mode.to_s == 'force' then -%>
    RewriteEngine On
    RewriteCond %{HTTPS} !=on
    RewriteRule (.*) https://%{SERVER_NAME}$1 [R=permanent,L]

    <%- end -%>
    <%- if default_charset.to_s != 'absent' then -%>
    AddDefaultCharset <%= default_charset %>

    <%- end -%>
    <%- if run_mode.to_s =~ /(proxy\-|static\-)?itk/ -%>
    <IfModule mpm_itk_module>
        AssignUserId <%= run_uid+" "+run_gid %>
    </IfModule>

    <%- end -%>
    <%- if not ssl_mode.to_s == 'force' then -%>
    DAVLockDB <%= real_dav_db_dir %>/DAVLock
    <Directory "<%= documentroot %>/">
        Dav on
        AllowOverride None
        <%- if options.to_s != 'absent' or do_includes.to_s == 'true' then -%>
        Options <%- unless options.to_s == 'absent' then -%><%= options %><%- end -%><%- unless options.include?('Indexes') then -%> Indexes<%- end -%>

        <%- else -%>
        Options Indexes

        <%- end -%>
<%= scope.function_template('apache/vhosts/partials/authentication.erb') %>
        <%- if ldap_auth.to_s == 'true' then -%>
        Include include.d/ldap_auth.inc
        <%- unless ldap_user.to_s == 'any' -%>
        Require ldap-user <%= ldap_user.to_s %>
        <%- else -%>
        Require valid-user
        <%- end -%>
        <%- end -%>
    </Directory>
    <%- end -%>

    <%- unless run_mode.to_s =~ /(proxy\-|static\-)itk/ -%>
<%= scope.function_template('apache/vhosts/partials/mod_security.erb') %>
    <%- end -%>

    <%- unless additional_options.to_s == 'absent' then -%>
    <%= additional_options %>
    <%- end -%>
</VirtualHost>
<%- end -%>

<%- unless ssl_mode.to_s == 'false'  then -%>
<VirtualHost *:443>
    Include include.d/defaults.inc
    Include include.d/ssl_defaults.inc

    ServerName <%= servername %>
    <%- unless serveralias.to_s.empty? then -%>
    ServerAlias <%= serveralias %>
    <%- end -%> 
    <%- unless server_admin.to_s.empty? or server_admin.to_s == 'absent' then -%>
    ServerAdmin <%= server_admin %>
    <%- end -%>
    DocumentRoot <%= documentroot %>/

<%= scope.function_template('apache/vhosts/partials/logs.erb') %>
    <%- if default_charset.to_s != 'absent' then -%>

    AddDefaultCharset <%= default_charset %>
    <%- end -%>
    <%- if run_mode.to_s =~ /(proxy\-|static\-)?itk/ -%>

    <IfModule mpm_itk_module>
        AssignUserId <%= run_uid+" "+run_gid %>
    </IfModule>
    <%- end -%>

    Header add Strict-Transport-Security "max-age=15768000"

    DAVLockDB <%= real_dav_db_dir %>/DAVLock
    <Directory "<%= documentroot %>/">
        Dav on
        AllowOverride None
        <%- if options.to_s != 'absent' or do_includes.to_s == 'true' then -%>
        Options <%- unless options.to_s == 'absent' then -%><%= options %><%- end -%><%- unless options.include?('Indexes') then -%> Indexes<%- end -%>

        <%- else -%>
        Options Indexes

        <%- end -%>
<%= scope.function_template('apache/vhosts/partials/authentication.erb') %>
        <%- if ldap_auth.to_s == 'true' then -%>
        Include include.d/ldap_auth.inc
        <%- unless ldap_user.to_s == 'any' -%>
        Require ldap-user <%= ldap_user.to_s %>
        <%- else -%>
        Require valid-user
        <%- end -%>
        <%- end -%>
    </Directory>

    <%- unless run_mode.to_s =~ /(proxy\-|static\-)itk/ -%>
<%= scope.function_template('apache/vhosts/partials/mod_security.erb') %>
    <%- end -%>

    <%- unless additional_options.to_s == 'absent' then -%>
    <%= additional_options %>
    <%- end -%>
</VirtualHost>
<%- end -%>
<%- if run_mode.to_s =~ /(proxy\-|static\-)itk/ -%>
</IfDefine>
<IfDefine !HttpdLocal>
<%- unless ssl_mode.to_s == 'only'  then -%>
<VirtualHost *:80>
    Include include.d/defaults.inc

    ServerName <%= servername %>
    <%- unless serveralias.to_s.empty? then -%>
    ServerAlias <%= serveralias %>
    <%- end -%>
    <%- unless server_admin.to_s.empty? or server_admin.to_s == 'absent' then -%>
    ServerAdmin <%= server_admin %>
    <%- end -%>

<%= scope.function_template('apache/vhosts/partials/logs.erb') %>

    ProxyPreserveHost On
    ProxyRequests off
    ProxyPass / http://127.0.0.1/
    ProxyPassReverse / http://127.0.0.1/

    <%- if ssl_mode.to_s == 'force' then -%>
    RewriteEngine On
    RewriteCond %{HTTPS} !=on
    RewriteRule (.*) https://%{SERVER_NAME}$1 [R=permanent,L]

    <%- end -%>
    <%- if default_charset.to_s != 'absent' then -%>
    AddDefaultCharset <%= default_charset %>

    <%- end -%>
<%= scope.function_template('apache/vhosts/partials/mod_security.erb') %>

    <%- unless additional_options.to_s == 'absent' then -%>
    <%= additional_options %>
    <%- end -%>
</VirtualHost>
<%- end -%>

<%- unless ssl_mode.to_s == 'false'  then -%>
<VirtualHost *:443>
    Include include.d/defaults.inc
    Include include.d/ssl_defaults.inc

    ServerName <%= servername %>
    <%- unless serveralias.to_s.empty? then -%>
    ServerAlias <%= serveralias %>
    <%- end -%>
    <%- unless server_admin.to_s.empty? or server_admin.to_s == 'absent' then -%>
    ServerAdmin <%= server_admin %>
    <%- end -%>

<%= scope.function_template('apache/vhosts/partials/logs.erb') %>

    ProxyPreserveHost On
    ProxyRequests off
    SSLProxyEngine On
    ProxyPass / https://127.0.0.1/
    ProxyPassReverse / https://127.0.0.1/
    <%- if default_charset.to_s != 'absent' then -%>

    AddDefaultCharset <%= default_charset %>
    <%- end -%>

    Header add Strict-Transport-Security "max-age=15768000"

<%= scope.function_template('apache/vhosts/partials/mod_security.erb') %>

    <%- unless additional_options.to_s == 'absent' then -%>
    <%= additional_options %>
    <%- end -%>
</VirtualHost>
<%- end -%>
</IfDefine>
<%- end -%>
